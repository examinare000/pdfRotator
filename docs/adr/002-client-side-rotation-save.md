# ADR-002: PDF回転・保存処理をフロントエンドで完結させる方針

## ステータス
採用済み（2025-12-15）

## 背景
- MVPで要求される操作（表示・ページ移動・回転・保存）がすべてブラウザ上で完結するUXを提供したい。
- ユーザーのPDFをサーバに送信せず、プライバシーリスクやネットワーク遅延を避けたい。
- バックエンドはOCR向き判定APIのみを持つシンプル構成とし、PDF編集系のサーバ実装・スケーリングを避けたい。

## 決定
- PDFの表示・回転・保存はすべてフロントエンドで行う。
  - レンダリングは PDF.js（`GlobalWorkerOptions.workerSrc` を `public/pdf.worker.js` に設定）。
  - 回転適用と保存は pdf-lib を用い、ページごとの回転マップを `0|90|180|270` の90度単位で保持する。
  - 保存時に回転マップを全ページへ適用し、`rotated.pdf` を Blob として生成して自動ダウンロード（モバイルSafariは Blob URL を新規タブで開くフォールバック）。
  - PDFファイルは ArrayBuffer としてブラウザメモリ上のみで扱い、サーバへアップロードしない。
- クライアントの制約値
- アップロード上限の目安は 300MB。空バッファはエラーとする。
  - キャンバス解像度はデバイス幅でクランプし、直近ページのみキャッシュ（最大3ページ）してOOMを防ぐ。
- OCR向きレコメンドは任意ページをPNG化して `/api/ocr/orientation` に送信し、回転マップへはユーザー操作で反映する（自動適用はしない）。

## 根拠
- プライバシー: PDFがブラウザ外へ出ないため、機密文書でも利用しやすい。
- パフォーマンス: ネットワーク往復なしで即時回転・保存ができ、100ページ程度でも初期描画を3秒以内に収めやすい。
- シンプル運用: サーバ側はOCR APIとヘルスチェックのみで済み、ストレージやジョブキューを不要にできる。
- 一貫性: 回転の正規化と適用を同一のクライアントロジックで行うことで、表示と保存結果の不整合を防ぐ。

## トレードオフ
- ブラウザメモリを消費するため、極端に大きい/高解像度PDFではパフォーマンスが低下する可能性がある。
- 古いブラウザや低スペック端末ではPDF.jsレンダリングが重く、サーバ側レンダリングのような代替経路がない。
- サーバ保存を前提とした機能（共有リンク生成、履歴管理）は別途実装が必要。

## 採用した代替案と理由
- 代替案: サーバ側でPDF回転・保存を行い、加工済みファイルをダウンロードさせる  
  - 理由: ネットワーク転送コスト（アップロード+ダウンロード）がUXを悪化させること、サーバがファイルI/OとCPU負荷を抱えスケールコストが増えること、機密文書送信の懸念があるため不採用。
- 代替案: 画像化した全ページをフロントで再合成してPDFに戻す  
  - 理由: 画質劣化とファイルサイズ肥大化、実装・計算コストが大きく、pdf-libでページ回転を適用する方がシンプルなため不採用。

## 影響範囲
- フロントエンド: PDF.jsワーカー配置、回転マップ管理、保存処理実装、Blobダウンロード/フォールバック実装、OOMを避けるキャッシュ戦略。
- バックエンド: PDF処理は非対応。OCR APIのみ提供し、CORS設定でフロントのオリジンを許可する。
- 運用: サーバストレージ不要。ブラウザ互換性と大容量ファイル時のパフォーマンス検証を継続的に行う。
